<!DOCTYPE html>
<html>
  <head>
    <title>WordPress.com REST API XMLHttpRequest Media Upload Test Page</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>
  <body>
    <input type="file" id="file" multiple>
    <script src="http://wzrd.in/standalone/url@0.10.x"></script>
    <script src="http://wzrd.in/standalone/querystring@0.2.x"></script>
    <script src="../../dist/wpcom-xhr-request.js"></script>
    Select one or more files to upload to site ID: <span id="site"></span>
    <script>
      var hash, parsed;

      // parse the current URL, in case of an OAuth token response
      parsed = url.parse(location.href, true);

      // we have to parse the "hash" manually
      if (parsed.hash && parsed.hash.length > 1) {
        hash = querystring.parse(parsed.hash.substring(1));
      }

      function onchange (e) {
        // construct a 2D `formData` array for the selected files
        var formData = [];
        for (var i = 0; i < e.target.files.length; i++) {
          formData.push(['media[]', e.target.files[i]]);
        }
        console.log(formData);

        // do the API request through a CORS XHR request
        var req = WPCOM.xhr({
          authToken: hash.access_token,
          path: '/sites/' + hash.site_id + '/media/new',
          method: 'POST',
          formData: formData
        }, function(err, res){
          console.error(arguments);
          if (err) throw err;
          console.log(res);
        });

        req.upload.addEventListener('progress', onprogress, false);
      }

      function onprogress (e) {
        if (e.lengthComputable) {
          var percentComplete = e.loaded / e.total;
          console.log(e.loaded, e.total, percentComplete);
        } else {
          // Unable to compute progress information since the total size is unknown
        }
      }

      if (hash && hash.access_token) {
        // OAuth response
        document.getElementById('site').innerHTML = hash.site_id;

        // select files on the "input" element
        var input = document.getElementById('file');
        input.onchange = onchange;
      } else {
        // redirect to OAuth page
        var authorizeEndpoint = 'https://public-api.wordpress.com/oauth2/authorize';
        var params = {
          client_id: '37197',
          response_type: 'token',
          redirect_uri: 'http://localhost:3000/examples/browser/upload.html'
        };
        window.location = authorizeEndpoint + '?' + querystring.stringify(params);
      }
    </script>
  </body>
</html>
